/* generated by info.scce.dime.generator.scheme.ControllerGenerator */
package de.ls5.dywa.generated.controller.onbroke.models.app;

import de.ls5.dywa.generated.entity.onbroke.models.app.User;
import de.ls5.dywa.generated.entity.onbroke.models.app.UserImpl;
import de.ls5.dywa.generated.entity.onbroke.models.app.UserSearch;

import java.util.Arrays;
import java.util.stream.Collectors;

@javax.enterprise.context.RequestScoped
public class UserControllerImpl implements UserController {
	private static final org.slf4j.Logger LOGGER =  org.slf4j.LoggerFactory.getLogger(UserController.class);

	@javax.persistence.PersistenceContext
	private javax.persistence.EntityManager entityManager;

	@javax.inject.Inject
	private de.ls5.dywa.generated.util.DomainFileController domainFileController;

@javax.inject.Inject //referenceMap
private de.ls5.dywa.generated.controller.onbroke.models.app.UserController userController;

@javax.inject.Inject //referenceMap
private de.ls5.dywa.generated.controller.onbroke.models.app.BaseUserController baseUserController;

@javax.inject.Inject //referenceMap
private de.ls5.dywa.generated.controller.onbroke.models.app.OfferController offerController;

@javax.inject.Inject //referenceMap
private de.ls5.dywa.generated.controller.onbroke.models.app.BiddingController biddingController;

    
    @Override
	public User read(final java.lang.Long id) {

		 User result = entityManager.find(UserImpl.class, id);
		 	// delegate read until entity is found;
		return result;
	}

    @Override
	public java.util.List<User> findByProperties(User searchObject) {
		if (searchObject instanceof UserSearch) {
			UserSearch casted = (UserSearch) searchObject;

			java.util.List<User> list = buildSimpleQuery(casted.queryAttributes(), casted.queryListAttributes(), true).getResultList().stream().map(User::casted).collect(Collectors.toList());

			return list;
		} else {
			throw new java.lang.IllegalArgumentException("Search object required.");
		}
	}

	@Override
	public User findFirstByProperties(User searchObject) {
		if (searchObject instanceof UserSearch) {
			UserSearch casted = (UserSearch) searchObject;
			java.util.List<User> results = new java.util.ArrayList<User>();
			results.addAll(buildSimpleQuery(casted.queryAttributes(), casted.queryListAttributes(),false).setMaxResults(1).getResultList());
			return results.isEmpty() ? null : results.get(0);
		} else throw new java.lang.IllegalArgumentException("Search object required.");
	}

	@Override
	public java.util.Set<User> fetch() {
		return new java.util.HashSet<User>(buildSimpleQuery(null, null,false).getResultList());
	}

	@Override
	public java.util.Set<User> fetchByName(final java.lang.String name) {
		java.util.Map<String, Object> map = new java.util.HashMap<>();
		map.put("name_", name);
		java.util.HashSet<User> result = new java.util.HashSet<>(buildSimpleQuery(map, null,false).getResultList());
		return result;
	}

		@Override
		public User create(java.lang.String name) {
			UserImpl entity = new UserImpl();
			entity.setDywaName(name);
			entityManager.persist(entity);
			return entity;
		}

		@Override
		public User createTransient(java.lang.String name) {
			UserImpl entity = new UserImpl();
			entity.setDywaName(name);
			return entity;
		}

	@Override
	public User createSearchObject(java.lang.String name) {
		return new UserSearch(name);
	}

	@Override
	public java.util.Set<User> fetchWithSubtypes() {
		java.util.Set<User> list = buildSimpleQuery(null,null, true).getResultList().stream().map(User::casted).collect(Collectors.toSet());

		return list;
	}

	@Override
	public void delete(User entity) {

		if (entity instanceof UserImpl) {
			UserImpl impl = (UserImpl) entity;
			entityManager.remove(impl);
		}
		// delegate delete
	}
	
	@Override
	public void deleteWithIncomingReferences(User entityToDelete) {

		
		// Delete references from type BaseUser
			de.ls5.dywa.generated.entity.onbroke.models.app.BaseUser searchBaseUser;
			searchBaseUser = new de.ls5.dywa.generated.entity.onbroke.models.app.BaseUserSearch();	
				searchBaseUser.setuser_User(java.util.Arrays.asList(entityToDelete));
			for (de.ls5.dywa.generated.entity.onbroke.models.app.BaseUser queryResult : this.baseUserController.findByProperties(searchBaseUser)) {
				queryResult.getuser_User().remove(entityToDelete);
			}
		
		// Delete references from type Bidding
			de.ls5.dywa.generated.entity.onbroke.models.app.Bidding searchBidding;
			searchBidding = new de.ls5.dywa.generated.entity.onbroke.models.app.BiddingSearch();	
				searchBidding.setuser(entityToDelete);
			for (de.ls5.dywa.generated.entity.onbroke.models.app.Bidding queryResult : this.biddingController.findByProperties(searchBidding)) {
				queryResult.setuser(null);
			}
		
		// Delete references from type Offer
			de.ls5.dywa.generated.entity.onbroke.models.app.Offer searchOffer;
			searchOffer = new de.ls5.dywa.generated.entity.onbroke.models.app.OfferSearch();	
				searchOffer.setuser(entityToDelete);
			for (de.ls5.dywa.generated.entity.onbroke.models.app.Offer queryResult : this.offerController.findByProperties(searchOffer)) {
				queryResult.setuser(null);
			}
		
		// Delete references from type User
			de.ls5.dywa.generated.entity.onbroke.models.app.User searchUser;
			searchUser = new de.ls5.dywa.generated.entity.onbroke.models.app.UserSearch();	
				searchUser.setdywaSwitchedTo(entityToDelete);
			for (de.ls5.dywa.generated.entity.onbroke.models.app.User queryResult : this.userController.findByProperties(searchUser)) {
				queryResult.setdywaSwitchedTo(null);
			}
		delete(entityToDelete);
	}
	
	private javax.persistence.TypedQuery<UserImpl> buildSimpleQuery(java.util.Map<String, Object> attributeMap, java.util.Map<String, java.util.List> listAttributeMap, boolean withInherited) {
		java.lang.StringBuilder queryStr = new java.lang.StringBuilder("SELECT e FROM UserImpl e WHERE (true="+withInherited+" OR e.inheritance_ = false)");
		if (attributeMap != null) {
			for (java.util.Map.Entry<String, Object> entry : attributeMap.entrySet()) {
				queryStr.append(" AND e." + entry.getKey() + " = :" + entry.getKey().replaceAll("\\W", ""));
			}
		}
		if (listAttributeMap != null) {
			for (java.util.Map.Entry<String, java.util.List> entry : listAttributeMap.entrySet()) {
				if (entry.getValue() == null || entry.getValue().isEmpty()) {
					queryStr.append(" AND e." + entry.getKey() + " IS EMPTY");
				} else {
					String prefix = entry.getKey().replaceAll("\\W", "");
					for (int i = 0, s = entry.getValue().size(); i < s; i++) {
						queryStr.append(" AND :" + prefix + i + " MEMBER OF e." + entry.getKey());
					}
				}
			}
		}
		queryStr.append(" ORDER BY id_ DESC");
		javax.persistence.TypedQuery<UserImpl> query = entityManager.createQuery(queryStr.toString(), UserImpl.class);
		if (attributeMap != null) {
			for (java.util.Map.Entry<String, Object> entry : attributeMap.entrySet()) {
				query.setParameter(entry.getKey().replaceAll("\\W", ""), entry.getValue());
			}
		}
		if (listAttributeMap != null) {
			for (java.util.Map.Entry<String, java.util.List> entry : listAttributeMap.entrySet()) {
				if (entry.getValue() != null && !entry.getValue().isEmpty()) {
					String prefix = entry.getKey().replaceAll("\\W", "");
					for (int i = 0, s = entry.getValue().size(); i < s; i++) {
						query.setParameter(prefix + i, entry.getValue().get(i));
					}
				}
			}
		}
		query.setHint(org.hibernate.jpa.QueryHints.HINT_CACHEABLE,true);
		return query;
	}
}
